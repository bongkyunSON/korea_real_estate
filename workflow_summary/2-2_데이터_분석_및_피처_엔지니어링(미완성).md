# [Phase 2] ë°ì´í„° íŒŒì´í”„ë¼ì¸ êµ¬ì¶•

## 2-2. ë°ì´í„° ë¶„ì„ ë° í”¼ì²˜ ì—”ì§€ë‹ˆì–´ë§: 'ì›ì„'ì—ì„œ 'ë³´ì„'ì„ ê¿°ëŠ” ê³¼ì •

### 1. ê°œìš”

Phase 2-1ì—ì„œ ìš°ë¦¬ëŠ” ë°ì´í„°ë¼ëŠ” 'ì›ì„'ì„ ìë™ìœ¼ë¡œ ì±„êµ´í•˜ëŠ” 'ê´‘ì‚°(Airflow íŒŒì´í”„ë¼ì¸)'ì„ ì„±ê³µì ìœ¼ë¡œ ê±´ì„¤í–ˆìŠµë‹ˆë‹¤. í•˜ì§€ë§Œ ì›ì„ì€ ê·¸ ìì²´ë¡œëŠ” ê°€ì¹˜ë¥¼ ì œëŒ€ë¡œ ë°œíœ˜í•˜ì§€ ëª»í•©ë‹ˆë‹¤. AIë¼ëŠ” ì •êµí•œ ê¸°ê³„ë¥¼ ì‘ë™ì‹œí‚¤ê¸° ìœ„í•´ì„œëŠ”, ì´ ì›ì„ì„ ì •ë°€í•˜ê²Œ ê¹ê³  ë‹¤ë“¬ì–´ ë°˜ì§ì´ëŠ” 'ë³´ì„(Feature)'ìœ¼ë¡œ ë§Œë“œëŠ” ê³¼ì •ì´ ë°˜ë“œì‹œ í•„ìš”í•©ë‹ˆë‹¤.

ì´ë²ˆ ë‹¨ê³„ì˜ ëª©í‘œëŠ” ë°ì´í„° ì„¸ê³µì˜ ì¥ì¸ì´ ë˜ì–´, Jupyter Notebookì´ë¼ëŠ” ì‘ì—…ëŒ€ ìœ„ì—ì„œ ì›ì‹œ ë°ì´í„°ë¥¼ íƒí—˜í•˜ê³ , ìˆ¨ê²¨ì§„ íŒ¨í„´ì„ ì°¾ì•„ë‚´ë©°, ìµœì¢…ì ìœ¼ë¡œ AI ëª¨ë¸ì˜ ì„±ëŠ¥ì„ ê·¹ëŒ€í™”í•  ìˆ˜ ìˆëŠ” ê°•ë ¥í•œ í”¼ì²˜ë“¤ì„ ì„¤ê³„í•˜ê³  ì´ë¥¼ ìë™í™”í•˜ëŠ” ìŠ¤í¬ë¦½íŠ¸(`build_features.py`)ë¥¼ ì™„ì„±í•˜ëŠ” ê²ƒì´ì—ˆìŠµë‹ˆë‹¤.

### 2. ì ‘ê·¼ ì „ëµ: 'ë°ì´í„° íƒí—˜ê°€ì˜ í•­í•´ì¼ì§€' ë¹„ìœ 

ìš°ë¦¬ëŠ” ë¯¸ì§€ì˜ ë°ì´í„° ëŒ€ë¥™ì„ íƒí—˜í•˜ëŠ” íƒí—˜ê°€ì²˜ëŸ¼ ì²´ê³„ì ì¸ ë‹¨ê³„ë¥¼ ë°Ÿì•˜ìŠµë‹ˆë‹¤.

- **Phase 2-2A: íƒí—˜ ì¤€ë¹„ (Jupyter Notebook í™˜ê²½ êµ¬ì¶•)**
  - ì–´ë–¤ ì œì•½ë„ ì—†ì´ ììœ ë¡­ê²Œ ë°ì´í„°ë¥¼ ë§›ë³´ê³ , ì‹¤í—˜í•˜ê³ , ì‹œê°í™”í•  ìˆ˜ ìˆëŠ” íƒí—˜ ê¸°ì§€, `Jupyter Notebook`ì„ ì„¤ì¹˜í•˜ê³  ë°ì´í„°ë² ì´ìŠ¤ì™€ ì—°ê²°í–ˆìŠµë‹ˆë‹¤.

- **Phase 2-2B: ì‹ ëŒ€ë¥™ íƒí—˜ ë° ì§€ë„ ì œì‘ (EDA ë° í”¼ì²˜ ì—”ì§€ë‹ˆì–´ë§)**
  - ë§¤ë§¤ ë°ì´í„°ì™€ ì „ì›”ì„¸ ë°ì´í„°ë¼ëŠ” ë‘ ê°œì˜ ì‹ ëŒ€ë¥™ì„ íƒí—˜í•˜ë©° ì§€ë„ë¥¼ ì œì‘(EDA)í–ˆìŠµë‹ˆë‹¤. 'í‰ë‹¹ ê°€ê²©'ì´ë¼ëŠ” ì£¼ìš” ì‚°ë§¥ì„ ë°œê²¬í•˜ê³ , 'ìì¹˜êµ¬ë³„/ë™ë³„ ì‹œì¥ íŠ¹ì„±'ì´ë¼ëŠ” ì£¼ìš” ê°•ì¤„ê¸°ë¥¼ ê·¸ë ¤ ë„£ì—ˆìŠµë‹ˆë‹¤.

- **Phase 2-2C: ìˆ¨ê²¨ì§„ ë³´ë¬¼ ë°œêµ´ (í•µì‹¬ ì¸ì‚¬ì´íŠ¸ 'ê°­íˆ¬ì' ë¶„ì„)**
  - íƒí—˜ì˜ í•˜ì´ë¼ì´íŠ¸ëŠ” ì£¼ë‹ˆì–´ë‹˜ì˜ ë²ˆëœ©ì´ëŠ” ì•„ì´ë””ì–´ì—ì„œ ì‹œì‘ëœ 'ê°­íˆ¬ì'ë¼ëŠ” ìˆ¨ê²¨ì§„ ë³´ë¬¼ì„¬ì˜ ë°œê²¬ì´ì—ˆìŠµë‹ˆë‹¤. ìš°ë¦¬ëŠ” ë‘ ëŒ€ë¥™ì˜ ì§€ë„ë¥¼ ê²¹ì³ë³´ê³ , íŠ¹ì • ì¡°ê±´(ë§¤ë§¤ì¼ì´ ì „ì„¸ê³„ì•½ ê¸°ê°„ì— í¬í•¨)ì— ë§ëŠ” ì§€ì ì„ ì°¾ì•„ë‚´ ë³´ë¬¼ì˜ ìœ„ì¹˜ë¥¼ ì •í™•íˆ íŠ¹ì •í•˜ëŠ” ë° ì„±ê³µí–ˆìŠµë‹ˆë‹¤.

- **Phase 2-2D: ìµœì ì˜ í•­í•´ ê²½ë¡œ í™•ì • (ë¶„ì„ ë¡œì§ ìŠ¤í¬ë¦½íŠ¸í™”)**
  - íƒí—˜ì„ í†µí•´ ì–»ì€ ëª¨ë“  ì§€ì‹ê³¼ ë³´ë¬¼ ì§€ë„ë¥¼ ì¢…í•©í•˜ì—¬, `build_features.py`ë¼ëŠ” 'ìµœì ì˜ í•­í•´ ê²½ë¡œ'ë¥¼ ì™„ì„±í–ˆìŠµë‹ˆë‹¤. ì´ì œ ëˆ„êµ¬ë“  ì´ ìŠ¤í¬ë¦½íŠ¸ë§Œ ì‹¤í–‰í•˜ë©´, ìš°ë¦¬ê°€ ê²ªì—ˆë˜ ëª¨ë“  íƒí—˜ ê³¼ì •ì„ ì¬í˜„í•˜ê³  ë˜‘ê°™ì€ ë³´ë¬¼ì„ ì°¾ì•„ë‚¼ ìˆ˜ ìˆê²Œ ë˜ì—ˆìŠµë‹ˆë‹¤.

### 3. ë¶„ì„ ê³¼ì •ì—ì„œ ë§ˆì£¼í•œ ë„ì „ê³¼ í•´ê²°

íƒí—˜ ê³¼ì •ì€ ì–¸ì œë‚˜ì²˜ëŸ¼ ìˆœíƒ„ì¹˜ë§Œì€ ì•Šì•˜ìŠµë‹ˆë‹¤. ìš°ë¦¬ëŠ” ì—¬ëŸ¬ ë‚œê´€ì„ ë§ˆì£¼ì³¤ì§€ë§Œ, ë…¼ë¦¬ì ì¸ ì¶”ë¡ ì„ í†µí•´ ëª¨ë‘ í•´ê²°í–ˆìŠµë‹ˆë‹¤.

#### ğŸ§ ë„ì „ 1: ìˆ«ìë¡œ ë³´ì´ì§€ë§Œ ìˆ«ìê°€ ì•„ë‹ˆì—ˆë˜ ë°ì´í„°

- **í˜„ìƒ**: `df.describe(include='number')` ì½”ë“œê°€ `ValueError: No objects to concatenate` ì—ëŸ¬ë¥¼ ë¿œì–´ëƒˆìŠµë‹ˆë‹¤. ëª¨ë“  ë°ì´í„°ê°€ `object`(ë¬¸ìì—´) íƒ€ì…ì´ì—ˆê³ , íŠ¹íˆ `dealAmount` ì»¬ëŸ¼ì—ëŠ” ì‰¼í‘œ(`,`)ê°€ ì„ì—¬ ìˆì–´ ìˆ«ì ë³€í™˜ì´ ì‹¤íŒ¨í–ˆë˜ ê²ƒì…ë‹ˆë‹¤.
- **í•´ê²°**: `.str.replace(',', '')`ë¡œ ì‰¼í‘œë¥¼ ì œê±°í•˜ê³ , `pd.to_numeric` í•¨ìˆ˜ì˜ `errors='coerce'` ì˜µì…˜ì„ ì‚¬ìš©í•˜ì—¬ ë³€í™˜í•  ìˆ˜ ì—†ëŠ” ê°’ì€ NaNìœ¼ë¡œ ë§Œë“œëŠ” ì•ˆì „í•œ ë°©ì‹ìœ¼ë¡œ ëª¨ë“  ìˆ«ì ì»¬ëŸ¼ì„ ì„±ê³µì ìœ¼ë¡œ ë³€í™˜í–ˆìŠµë‹ˆë‹¤.

#### ğŸ§ ë„ì „ 2: ì´ë¦„ë§Œ ë³´ê³  ê°™ì€ ì‚¬ëŒì¸ ì¤„ ì•Œì•˜ë˜ ë°ì´í„°

- **í˜„ìƒ**: ë§¤ë§¤ ë°ì´í„°ë¥¼ ì²˜ë¦¬í–ˆë˜ ê²½í—˜ì„ ë°”íƒ•ìœ¼ë¡œ ì „ì›”ì„¸ ë°ì´í„°ì—ì„œ ë¶ˆí•„ìš”í•œ ì»¬ëŸ¼ì„ ì œê±°í•˜ë ¤ í•˜ì `KeyError`ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‘ ë°ì´í„°ì…‹ì´ ë¹„ìŠ·í•´ ë³´ì˜€ì§€ë§Œ, ì‹¤ì œ ì»¬ëŸ¼ ì´ë¦„ì€ ë¯¸ë¬˜í•˜ê²Œ ë‹¬ëìŠµë‹ˆë‹¤.
- **í•´ê²°**: 'ì¶”ì¸¡' ëŒ€ì‹  'í™•ì¸'ì„ ì„ íƒí–ˆìŠµë‹ˆë‹¤. `df_jeonse.isnull().sum()`ìœ¼ë¡œ ì‹¤ì œ ì»¬ëŸ¼ëª…ê³¼ ê²°ì¸¡ì¹˜ í˜„í™©ì„ ì§ì ‘ ëˆˆìœ¼ë¡œ í™•ì¸í•œ ë’¤, ì •í™•í•œ ì»¬ëŸ¼ëª…ì„ ì‚¬ìš©í•˜ì—¬ ë¬¸ì œë¥¼ í•´ê²°í–ˆìŠµë‹ˆë‹¤.

#### ğŸ§ ë„ì „ 3: ë°ì´í„°ì— ìˆ¨ê²¨ì§„ ì‹œëŒ€ì  ë°°ê²½ì˜ ë°œê²¬

- **í˜„ìƒ**: 'ê°­íˆ¬ì' ë¶„ì„ ë¡œì§ì„ ì²˜ìŒ ì™„ì„±í–ˆì„ ë•Œ, ìš°ë¦¬ëŠ” ëª¨ë“  ê¸°ê°„ì˜ ë°ì´í„°ë¥¼ ëŒ€ìƒìœ¼ë¡œ ë¶„ì„í–ˆìŠµë‹ˆë‹¤.
- **ë°œê²¬ (ì£¼ë‹ˆì–´ë‹˜ì˜ í•µì‹¬ ì¸ì‚¬ì´íŠ¸)**: ì£¼ë‹ˆì–´ë‹˜ê»˜ì„œ "2021ë…„ 6ì›” ì£¼íƒì„ëŒ€ì°¨ ì‹ ê³ ì œ ë²•ì œí™”"ë¼ëŠ” ê²°ì •ì ì¸ ë„ë©”ì¸ ì§€ì‹ì„ ì œê³µí•´ì£¼ì…¨ìŠµë‹ˆë‹¤. ì´ë¡œ ì¸í•´ 2022ë…„ ì´ì „ì˜ `contractTerm` ë°ì´í„°ëŠ” ì‹ ë¢°ë„ê°€ ë‚®ë‹¤ëŠ” ê²ƒì„ ê¹¨ë‹¬ì•˜ìŠµë‹ˆë‹¤.
- **í•´ê²°**: ë¶„ì„ì˜ ì •í™•ë„ë¥¼ ë†’ì´ê¸° ìœ„í•´, `deal_datetime >= '2022-01-01'` ì¡°ê±´ì„ ì¶”ê°€í•˜ì—¬ ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” ê¸°ê°„ì˜ ë°ì´í„°ë§Œì„ ëŒ€ìƒìœ¼ë¡œ ë¶„ì„ì„ ì§„í–‰í–ˆìŠµë‹ˆë‹¤. ì´ëŠ” ê¸°ìˆ ì  í•´ê²°ì„ ë„˜ì–´, **ë°ì´í„°ì˜ ìƒì„± ë°°ê²½ì„ ì´í•´í•˜ëŠ” ê²ƒì´ ì–¼ë§ˆë‚˜ ì¤‘ìš”í•œì§€ ë³´ì—¬ì¤€ ìµœê³ ì˜ ì‚¬ë¡€**ì˜€ìŠµë‹ˆë‹¤.

### 4. ìµœì¢… ê²°ê³¼ë¬¼: `build_features.py`

ê¸¸ê³  ê¸´ íƒí—˜ê³¼ ë¶„ì„ ëì— ì™„ì„±ëœ, ìš°ë¦¬ì˜ ëª¨ë“  ì§€ì‹ê³¼ ë¡œì§ì´ ì§‘ì•½ëœ ìµœì¢… ìŠ¤í¬ë¦½íŠ¸ì…ë‹ˆë‹¤.

```python
import os
import pandas as pd
import numpy as np
from sqlalchemy import create_engine
from dotenv import load_dotenv
import warnings

# ê²½ê³  ë©”ì‹œì§€ ë¬´ì‹œ
warnings.filterwarnings('ignore', category=UserWarning, module='pandas')

def get_db_engine():
    """ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì—”ì§„ì„ ìƒì„±í•˜ê³  ë°˜í™˜í•©ë‹ˆë‹¤."""
    dotenv_path = os.path.join(os.path.dirname(os.getcwd()), '.env')
    if not os.path.exists(dotenv_path):
         dotenv_path = os.path.join(os.getcwd(), '.env')
            
    load_dotenv(dotenv_path=dotenv_path)
    
    database_url = os.getenv("DATABASE_URL_HOST")
    if not database_url:
        raise ValueError("DATABASE_URL_HOST í™˜ê²½ ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")
    
    return create_engine(database_url)

def process_trade_data(engine, schema):
    """ë§¤ë§¤ ë°ì´í„°ë¥¼ ì²˜ë¦¬í•˜ê³  í”¼ì²˜ë¥¼ ìƒì„±í•©ë‹ˆë‹¤."""
    print("--- [1/4] ë§¤ë§¤ ë°ì´í„° ì²˜ë¦¬ ì‹œì‘ ---")
    
    print(">> raw_apt_trade í…Œì´ë¸” ë¡œë”© ì¤‘...")
    df = pd.read_sql(f'SELECT * FROM {schema}."raw_apt_trade"', engine)
    print(f">> ë§¤ë§¤ ë°ì´í„° {len(df)}ê±´ ë¡œë”© ì™„ë£Œ.")

    # ë°ì´í„° ì •ì œ ë° íƒ€ì… ë³€í™˜
    df['dealAmount'] = pd.to_numeric(df['dealAmount'].str.replace(',', '').str.strip(), errors='coerce')
    numeric_cols = ['excluUseAr', 'dealYear', 'dealMonth', 'dealDay', 'buildYear', 'floor']
    for col in numeric_cols:
        df[col] = pd.to_numeric(df[col], errors='coerce')

    # ê²°ì¸¡ì¹˜ ë° ì´ìƒì¹˜ ì²˜ë¦¬
    df.dropna(subset=['dealAmount', 'excluUseAr'], inplace=True)
    df = df[df['floor'] > 0].copy()

    # í”¼ì²˜ ì—”ì§€ë‹ˆì–´ë§
    df['deal_datetime'] = pd.to_datetime(df['dealYear'].astype(str) + '-' + 
                                       df['dealMonth'].astype(str) + '-' + 
                                       df['dealDay'].astype(str), errors='coerce')
    df['price_per_pyeong'] = df['dealAmount'] / (df['excluUseAr'] / 3.3058)

    sgg_map = df.groupby('sggCd')['sggNm'].first().to_dict()
    df['sggNm'] = df['sggCd'].map(sgg_map)

    dong_avg_price = df.groupby(['sggNm', 'umdNm'])['price_per_pyeong'].transform('mean')
    df['dong_avg_price'] = dong_avg_price
    
    # ë¶ˆí•„ìš”í•œ ì»¬ëŸ¼ ì œê±°
    final_cols = [
        'sggCd', 'umdCd', 'jibun', 'aptNm', 'excluUseAr', 'floor', 'buildYear', 
        'dealAmount', 'deal_datetime', 'sggNm', 'umdNm', 
        'price_per_pyeong', 'dong_avg_price'
    ]
    df_final = df[final_cols].copy()
    
    print("--- ë§¤ë§¤ ë°ì´í„° ì²˜ë¦¬ ì™„ë£Œ ---")
    return df_final

def process_rent_data(engine, schema):
    """ì „ì›”ì„¸ ë°ì´í„°ë¥¼ ì²˜ë¦¬í•˜ê³  í”¼ì²˜ë¥¼ ìƒì„±í•©ë‹ˆë‹¤."""
    print("--- [2/4] ì „ì›”ì„¸ ë°ì´í„° ì²˜ë¦¬ ì‹œì‘ ---")
    
    print(">> raw_apt_jeonse í…Œì´ë¸” ë¡œë”© ì¤‘...")
    df = pd.read_sql(f'SELECT * FROM {schema}."raw_apt_jeonse"', engine)
    print(f">> ì „ì›”ì„¸ ë°ì´í„° {len(df)}ê±´ ë¡œë”© ì™„ë£Œ.")

    # ë°ì´í„° ì •ì œ ë° íƒ€ì… ë³€í™˜
    numeric_cols = [
        'deposit', 'monthlyRent', 'excluUseAr', 'buildYear', 'dealYear', 
        'dealMonth', 'dealDay', 'floor', 'preDeposit', 'preMonthlyRent'
    ]
    for col in numeric_cols:
        df[col] = pd.to_numeric(df[col], errors='coerce')
    
    df.dropna(subset=['deposit', 'monthlyRent', 'excluUseAr'], inplace=True)

    # í”¼ì²˜ ì—”ì§€ë‹ˆì–´ë§
    df['rent_type'] = np.where(df['monthlyRent'] == 0, 'ì „ì„¸', 'ì›”ì„¸')
    df['deal_datetime'] = pd.to_datetime(df['dealYear'].astype(str) + '-' + 
                                       df['dealMonth'].astype(str) + '-' + 
                                       df['dealDay'].astype(str), errors='coerce')

    sgg_map = df.groupby('sggCd')['sggNm'].first().to_dict()
    df['sggNm'] = df['sggCd'].map(sgg_map)
    
    # ê³„ì•½ ê¸°ê°„ íŒŒì‹±
    term = df['contractTerm'].str.split('~', expand=True)
    df['contract_start_date'] = pd.to_datetime('20' + term[0].str.replace('.', '-'), errors='coerce')
    df['contract_end_date'] = pd.to_datetime('20' + term[1].str.replace('.', '-'), errors='coerce')

    # ì‹œì¥ íŠ¹ì„± í”¼ì²˜ ìƒì„±
    df_jeonse = df[df['rent_type'] == 'ì „ì„¸'].copy()
    df_wolse = df[df['rent_type'] == 'ì›”ì„¸'].copy()

    df_jeonse['price_per_pyeong'] = df_jeonse['deposit'] / (df_jeonse['excluUseAr'] / 3.3058)
    df_wolse['deposit_per_pyeong'] = df_wolse['deposit'] / (df_wolse['excluUseAr'] / 3.3058)

    # êµ¬ë³„/ë™ë³„ í‰ê· ê°’ ê³„ì‚°
    for group_col in ['sggNm', 'umdNm']:
        # ì „ì„¸
        jeonse_avg = df_jeonse.groupby(group_col)['price_per_pyeong'].transform('mean')
        df[f'{group_col}_avg_pp_jeonse'] = jeonse_avg
        # ì›”ì„¸
        wolse_deposit_avg = df_wolse.groupby(group_col)['deposit_per_pyeong'].transform('mean')
        df[f'{group_col}_avg_pp_wolse_deposit'] = wolse_deposit_avg
        wolse_rent_avg = df_wolse.groupby(group_col)['monthlyRent'].transform('mean')
        df[f'{group_col}_avg_monthly_rent'] = wolse_rent_avg

    final_cols = [
        'sggCd', 'umdCd', 'jibun', 'aptNm', 'excluUseAr', 'floor', 'buildYear', 'deposit', 'monthlyRent',
        'deal_datetime', 'sggNm', 'umdNm', 'rent_type', 'contract_start_date', 'contract_end_date',
        'sggNm_avg_pp_jeonse', 'umdNm_avg_pp_jeonse', 'sggNm_avg_pp_wolse_deposit',
        'umdNm_avg_pp_wolse_deposit', 'sggNm_avg_monthly_rent', 'umdNm_avg_monthly_rent'
    ]
    df_final = df[final_cols].copy()
    
    print("--- ì „ì›”ì„¸ ë°ì´í„° ì²˜ë¦¬ ì™„ë£Œ ---")
    return df_final

def analyze_gap_investment(df_trade, df_rent):
    """ê°­íˆ¬ì ë°ì´í„°ë¥¼ ë¶„ì„í•©ë‹ˆë‹¤."""
    print("--- [3/4] ê°­íˆ¬ì ë¶„ì„ ì‹œì‘ ---")

    sales_df = df_trade[df_trade['deal_datetime'].dt.year >= 2022].copy()
    sales_df['deal_year'] = sales_df['deal_datetime'].dt.year

    jeonse_df = df_rent[
        (df_rent['rent_type'] == 'ì „ì„¸') &
        (df_rent['contract_start_date'].notna()) &
        (df_rent['contract_end_date'].dt.year >= 2022)
    ].copy()

    apartment_key = ['sggNm', 'umdNm', 'jibun', 'aptNm', 'excluUseAr', 'floor']
    sales_df['sale_id'] = range(len(sales_df))

    total_sales = sales_df.groupby(['deal_year', 'sggNm', 'umdNm']).size().rename('ì´ ë§¤ë§¤ ê±´ìˆ˜')

    merged_df = pd.merge(sales_df, jeonse_df[apartment_key + ['contract_start_date', 'contract_end_date']], on=apartment_key, how='inner')
    
    gap_mask = (merged_df['deal_datetime'] >= merged_df['contract_start_date']) & \
               (merged_df['deal_datetime'] <= merged_df['contract_end_date'])

    unique_gap_deals = merged_df[gap_mask].drop_duplicates(subset=['sale_id'])
    gap_counts = unique_gap_deals.groupby(['deal_year', 'sggNm', 'umdNm']).size().rename('ê°­íˆ¬ì ê±´ìˆ˜')

    summary_df = pd.concat([total_sales, gap_counts], axis=1).fillna(0).astype(int)
    summary_df['ê°­íˆ¬ì ë¹„ìœ¨(%)'] = ((summary_df['ê°­íˆ¬ì ê±´ìˆ˜'] / summary_df['ì´ ë§¤ë§¤ ê±´ìˆ˜']) * 100).round(2)
    
    print(f">> ê°­íˆ¬ì ë¶„ì„ ì™„ë£Œ. ì´ {len(summary_df)}ê°œ ë™ë³„ ë°ì´í„° ìƒì„±.")
    print("--- ê°­íˆ¬ì ë¶„ì„ ì™„ë£Œ ---")
    return summary_df.reset_index()

def save_to_db(df, table_name, engine, schema):
    """ë°ì´í„°í”„ë ˆì„ì„ ë°ì´í„°ë² ì´ìŠ¤ í…Œì´ë¸”ì— ì €ì¥í•©ë‹ˆë‹¤."""
    print(f">> '{table_name}' í…Œì´ë¸” ì €ì¥ ì¤‘... ({len(df)}ê±´)")
    df.to_sql(table_name, engine, schema=schema, if_exists='replace', index=False)
    print(f">> '{table_name}' í…Œì´ë¸” ì €ì¥ ì™„ë£Œ.")

def main():
    """ë©”ì¸ ì‹¤í–‰ í•¨ìˆ˜"""
    engine = get_db_engine()
    schema = os.getenv("DB_SCHEMA", "public")
    
    # 1. ë§¤ë§¤ ë°ì´í„° ì²˜ë¦¬ ë° ì €ì¥
    feature_trade_df = process_trade_data(engine, schema)
    
    # 2. ì „ì›”ì„¸ ë°ì´í„° ì²˜ë¦¬ ë° ì €ì¥
    feature_rent_df = process_rent_data(engine, schema)
    
    # 3. ê°­íˆ¬ì ë¶„ì„
    analytics_gap_df = analyze_gap_investment(feature_trade_df, feature_rent_df)
    
    # 4. ìµœì¢… í…Œì´ë¸” ì €ì¥
    print("\n--- [4/4] ìµœì¢… ë°ì´í„°ë² ì´ìŠ¤ ì €ì¥ ì‹œì‘ ---")
    save_to_db(feature_trade_df, "feature_apt_trade", engine, schema)
    save_to_db(feature_rent_df, "feature_apt_rent", engine, schema)
    save_to_db(analytics_gap_df, "analytics_gap_investment", engine, schema)
    print("--- ëª¨ë“  ì‘ì—…ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ---")

if __name__ == "__main__":
    main()
```

### 5. ê²°ë¡  ë° ë‹¤ìŒ ë‹¨ê³„

ìš°ë¦¬ëŠ” ë§ˆì¹¨ë‚´ ì›ì‹œ ë°ì´í„°ë¥¼ AIê°€ í•™ìŠµí•  ìˆ˜ ìˆëŠ” ìµœì¢… í”¼ì²˜ ë°ì´í„°ë¡œ ë³€í™˜í•˜ëŠ” ëª¨ë“  ë¡œì§ì„ `build_features.py`ë¼ëŠ” í•˜ë‚˜ì˜ ìë™í™” ìŠ¤í¬ë¦½íŠ¸ì— ë‹´ì•„ë‚´ëŠ” ë° ì„±ê³µí–ˆìŠµë‹ˆë‹¤. ì´ê²ƒìœ¼ë¡œ ë°ì´í„° íŒŒì´í”„ë¼ì¸ì˜ 'ë‘ë‡Œ' ì„¤ê³„ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.

ì´ì œ Phase 2ì˜ ë§ˆì§€ë§‰ í¼ì¦ ì¡°ê°ì„ ë§ì¶œ ì‹œê°„ì…ë‹ˆë‹¤.

- **Phase 2-3: ë°ì´í„° íŒŒì´í”„ë¼ì¸ í†µí•©**
  - Phase 2-1ì—ì„œ ë§Œë“  'ì›ì„ ì±„êµ´ê¸°(Airflow DAG)'ê°€ ì›ì„ì„ ë‹¤ ìºë©´, ìš°ë¦¬ê°€ Phase 2-2ì—ì„œ ë§Œë“  'ë³´ì„ ì„¸ê³µê¸°(`build_features.py`)'ê°€ ìë™ìœ¼ë¡œ ì´ì–´ì„œ ì‘ë™í•˜ë„ë¡ ë‘ ì‹œìŠ¤í…œì„ ì—°ê²°í•˜ëŠ” ì‘ì—…ì„ ì‹œì‘í•©ë‹ˆë‹¤.
  - ì´ í†µí•©ì´ ëë‚˜ë©´, ìš°ë¦¬ëŠ” ë¹„ë¡œì†Œ **'ì›ì„ ì±„êµ´ë¶€í„° ë³´ì„ ì„¸ê³µê¹Œì§€' ëª¨ë“  ê³¼ì •ì´ ìë™ìœ¼ë¡œ ì´ë£¨ì–´ì§€ëŠ” ì™„ë²½í•œ ë°ì´í„° íŒŒì´í”„ë¼ì¸**ì„ ê°–ê²Œ ë  ê²ƒì…ë‹ˆë‹¤.
